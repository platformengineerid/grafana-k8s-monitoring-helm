{{ define "agent.config.loki" }}
// Loki
remote.kubernetes.secret "logs_service" {
  name = {{ include "kubernetes_monitoring.logs_service.secret.name" . }}
  namespace = {{ .Values.externalServices.loki.secret.namespace | default .Release.Namespace }}
}

{{- with .Values.externalServices.loki }}
loki.write "grafana_cloud_loki" {
  endpoint {
    url = nonsensitive(remote.kubernetes.secret.logs_service.data[{{ .hostKey }}]) + "{{ .writeEndpoint }}"
{{- if .tenantId }}
    tenant_id = remote.kubernetes.secret.logs_service.data[{{ .tenantIdKey }}]
{{- end }}
{{- if .proxyURL }}
    proxy_url = {{ .proxyURL | quote }}
{{- end }}
{{ if eq .authMode "basic" }}
    basic_auth {
      username = remote.kubernetes.secret.logs_service.data[{{ .basicAuth.usernameKey }}]
      password = remote.kubernetes.secret.logs_service.data[{{ .basicAuth.passwordKey }}]
    }
{{- end }}
  }
  external_labels = {
    {{- range $k, $v := .externalLabels }}
    {{ $k }} = {{ $v | quote }},
    {{- end }}
{{- end }}
    cluster = {{ required ".Values.cluster.name is a required value. Please set it and try again." .Values.cluster.name | quote }},
  }
}
{{ end }}
